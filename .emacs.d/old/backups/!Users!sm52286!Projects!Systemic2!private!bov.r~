dir <- '~/Projects/Systemic2/R/'
source(paste(dir, 'systemic.R', sep=''), chdir=TRUE)

make.transparent <- function(color, alpha) {
    b <- col2rgb(color)
    return(rgb(b['red', 1], b['green', 1], b['blue',1], alpha*255, maxColorValue=255))
}

plot.xyz <- function(iobj, xlim=NULL, ylim=NULL, colors, upto=1e6) {
    for (i in 20:length(iobj$times)) {
        plot(0, 0, xlim=xlim, ylim=ylim, type='p', xaxt='n', yaxt='n', xlab='',
             ylab='', pch=19, bg='transparent')

        for (j in seq(20, 0, -2)) {
            for (k in 1:iobj$nplanets) {
                c <- make.transparent(colors[k], 1-(j / 20)^0.25)
                points(iobj$xyz[[k]][i-j, 2], iobj$xyz[[k]][i-j, 4], col=c, pch=19)
            }
        }
    }
}

copy.from <- function(k, i) {
    idx <- length(i$times)
    k$epoch <- i$times[idx]

    for (j in 1:k$nplanets) {
        for (b in 1:5) {
            k[j, b] <- i$els[[j]][idx, b]
        }
    }
}

png('frames/Rplot%03d', width=1024, height=1024)
colors = c(rgb(1, 0, 0, 1), rgb(0, 1, 0, 1), rgb(0, 0, 1, 1))

k <- knew()
k[] <- c(period=10, mass=0.1)
k$epoch <- 0
k$int.method <- RK89

times <- seq(k$epoch, k$epoch + 365.25, 0.1)
i <- kintegrate(k, times)

plot.xyz(i, xlim=c(-1, 1), ylim=c(-1, 1), colors=colors)

copy.from(k, i)
k[] <- c(period=32, mass=0.4)
times <- seq(k$epoch, k$epoch + 365.25, 0.1)
i <- kintegrate(k, times) 
plot.xyz(i, xlim=c(-1, 1), ylim=c(-1, 1), colors=colors)
