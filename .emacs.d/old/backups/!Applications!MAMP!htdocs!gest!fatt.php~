<?php
	require('lib.php');
	mysql_select_db("mathalic_gest");
		
	$headers = array("numfat", "data", "ragione",
		"importo", "saldo", "datasaldo");
	
	if (isset($_GET["action"]) && $_GET["action"] == "delete") {
		$id = $_GET['id'];
		require("top.php");
		?>
		<div class="alert">
		Vuoi davvero cancellare questa fattura? 
		<ul>
		<li><a href="fatt.php?action=dodelete&id=<?= $id ?>">Si', cancella</a>
		<li><a href="fatt.php">No, torna indietro</a>
		</ul>
		</div>
		<?php
		mysql_print("Fatture", $headers, null, "WHERE id='" . $id . "'");
		return;
	}
	
	if (isset($_GET["action"]) && $_GET["action"] == "dodelete") {
		mysql_query("DELETE FROM Fatture WHERE ID=" . $_GET["id"]);
		mysql_select_db("mathalic_fatture");
		mysql_query("DROP TABLE `" . $_GET["id"] . "`");
		echo "<script>";
		echo "alert('Fattura cancellata!');";
		echo "location.href='fatt.php';";
		echo "</script>";
		return;
	}
	
	if (isset($_GET["action"]) && $_GET["action"] == "search" && isset($_POST["cliente"])) {
		setcookie("est_cliente", stripslashes($_POST["cliente"]),
			time() + 3600);
		setcookie("est_year", $_POST["year"],
			time()+3600);			
		setcookie("est_da_pagare", isset($_POST["da_pagare"]), time() + 3600);

		$search = $_POST["cliente"];
		$year = $_POST["year"];		
		$da_pagare = isset($_POST["da_pagare"]);
	} else {
		if (isset($_COOKIE["est_cliente"]))
			$search = $_COOKIE["est_cliente"];
		else
			$search = "";
			
		if (isset($_COOKIE["est_year"]))
			$year = $_COOKIE["est_year"];
		else
			$year = date("Y");	
		if (isset($_COOKIE["est_da_pagare"]))
			$da_pagare = $_COOKIE["est_da_pagare"];
		else
			$da_pagare = false;	
	}
	
	if (isset($_GET["action"]) && $_GET["action"] == "update") {
		$arr = array("saldo" => $_GET["saldo"],
		"datasaldo" => date_tosql($_GET["datasaldo"]));
		$id = $_GET["id"];
		mysql_update("Fatture", $arr, $id);
		header("Location:fatt.php");		
		return;

	}
	
	$clientiarr = mysql_array("SELECT * FROM Clienti ORDER BY ragione");
	
	require("top.php");
?>
<style>
#topbar #fatt {
	color:black;
	background-color:white;
	border:2px solid silver;
	border-bottom:none;
}
</style>

<div id="searchbar">
<form name="searchform" action="fatt.php?action=search" method="post">
Cliente : 
<input name="cliente" id="cliente" type="text" size=40 value="<?= html_escape($search) ?>">
&nbsp;
&nbsp;
Anno:
<input name="year" value="<?= $year ?>">
<input type="checkbox" name="da_pagare" onClick="searchform.submit()" <?= ($da_pagare ? "checked" : "") ?>> Visualizza solo da pagare
<input type="submit" value="Cerca">
<input type="button" value="<?= (file_exists("draft_cli")  ? "Continua fattura" : "Nuova fattura") ?>" class="new" onClick="location.href='fatt_new.php?action=new';">
<input type="button" value="Stampa" onClick="window.print();" class="print">
</form>
<?php
	$numfats = mysql_array("SELECT numfat FROM Fatture WHERE YEAR(data)=$year ORDER BY numfat");
	for ($i = 1; $i < count($numfats); $i++) {

		if (($numfats[$i]['numfat'] - $numfats[$i-1]['numfat']) != 1) {
			echo "<div class=\"alert\">";
			echo "Buco in numerazione fatture " . $numfats[$i-1]['numfat'] . " => " . $numfats[$i]['numfat'];
			echo "</div>";
		}
	}
?>

<script>
	function initAuto() {
		var clients = [];
		<?php
		foreach ($clientiarr as $cliente) {
			echo "clients.push('" . addslashes($cliente['ragione']) . "');\n";
		};
		?>
		$("#cliente").autocomplete({
			source:clients,
			minLength:0,
			delay:0,
		});
	}
	$("#cliente").keyup(initAuto);
	
</script>
</div>
<div id="summary">
Cliente: <?= $search ?>, Anno: <?= $year ?>.
</div>
<div id="counter"></div>
<div id="newSaldo" style="display:none">
<form name="saldoForm" id="saldoForm">
<fieldset>
Saldo:<br>
<input size="20" name="saldo" id="saldo"><p>
Data saldo:<br>
<input type="text" name="data" id="data"><p>
Importo:<br>
<input type="text" disabled name="importo" id="importo" size="20" style="font-style:italic; border:2px solid red"><p>
</fieldset>
</form>
</div>

<script>
	$( "#data" ).datepicker({
			dateFormat:"dd/mm/yy",
			firstDay:1,
			monthNamesShort:["Gen", "Feb", "Mar", "Apr", "Giu", "Lug", "Ago", "Set", "Ott", "Nov", "Dic"],
			dayNamesMin:["Lun", "Mar", "Mer", "Gio", "Ven", "Sab", "Dom"],
			monthNames:["Gennaio", "Febbraio", "Marzo", "Aprile", "Maggio", "Giugno", "Luglio", "Agosto", "Settembre", "Ottobre", "Novembre", "Dicembre"]
		});
	function saldo(id, saldo, importo, rag) {
		$("#importo").val(importo);
		$("#saldo").val(saldo);
		$("#newSaldo").dialog({
		modal:true,
		width:400,
		resizable:false,
		title:rag,
		buttons: {
			"Aggiorna saldo": function() {
				if ($("#data").val().trim() == "") {
					alert("Immettere una data valida.");
					return;
				}
				if ($("#saldo").val().trim() == "") {
					alert("Immettere un saldo valido.");
					return;
				}
				
				
				location.href="fatt.php?" +
					"action=update" +
					"&id=" + id +
					"&saldo=" + encodeURIComponent($("#saldo").val()) +
					"&datasaldo=" + encodeURIComponent($("#data").val());
			}
		}
	});
	};
</script>

<?php
	
	$cond = "WHERE YEAR(data)=" . $year;

	if ($search) {
		$cond = $cond . " AND CONCAT(" .
			implode(",", $headers) . ") LIKE \"%" . $search . "%\"";
	}
	
	if ($da_pagare) {
		$cond = $cond . " AND NOT(importo = saldo)";
	}
	$cond = $cond . " ORDER BY NUMFAT DESC";
	mysql_select_db("mathalic_gest");
	$arr = mysql_array("SELECT * FROM Fatture " . $cond);
?>
<table class="print">
<tr>
<th>Num.</th>
<th>Data</th>
<th>Cliente</th>
<th>Importo</th>
<th>Saldo</th>
<th>Data saldo</th>
<th></th>
</tr>
<?php
	$totimporto = 0.;
	$totsaldo = 0.;
	foreach ($arr as $entry) {
		$totimporto += $entry['importo'];
		$totsaldo += $entry['saldo'];
		
		if ($entry['saldo'] == $entry['importo']) 
			echo "<tr class=\"paid entry\">";
		else
			echo "<tr class=\"unpaid entry\">";
		
		echo "<td onClick=\"location.href='fatt_new.php?id=" . $entry['id'] . "';\">" . $entry['numfat'] . "</td>";
		echo "<td onClick=\"location.href='fatt_new.php?id=" . $entry['id'] . "';\">" . date_fromsql($entry['data']) . "</td>";
		echo "<td onClick=\"location.href='fatt_new.php?id=" . $entry['id'] . "';\">" . $entry['ragione'] . "</td>";
		echo "<td onClick=\"location.href='fatt_new.php?id=" . $entry['id'] . "';\">" . sprintf("%.2f", $entry['importo']) . "</td>";
		echo "<td onClick=\"location.href='fatt_new.php?id=" . $entry['id'] . "';\">" . sprintf("%.2f", $entry['saldo']) . "</td>";
		echo "<td onClick=\"location.href='fatt_new.php?id=" . $entry['id'] . "';\">" . date_fromsql($entry['datasaldo']) . "</td>";
		echo "<td><input type=\"button\" value=\"Apri\" onClick=\"location.href='fatt_new.php?id=" . $entry['id'] . "';\">&nbsp;";
		
		
		echo "<input type=\"button\" value=\"Saldo\" onClick=\"saldo({$entry['id']}, {$entry['saldo']}, {$entry['importo']}, '{$entry['ragione']} del {$entry['data']}');\">&nbsp;";
		echo "<input type=\"button\" value=\"X\" class=\"deleteButton\" onClick=\"location.href='fatt.php?action=delete&id={$entry['id']}';\">";
		
		echo "</tr>\n";
	}
?>
<script>

$("#counter").html("<?= count($arr) ?> fatture. Totale: <strong><?= sprintf("%.2f", $totimporto) ?></strong>, saldato: <strong><?= sprintf("%.2f", $totsaldo) ?></strong>, da pagare: <strong><?= sprintf("%.2f", $totimporto - $totsaldo) ?></strong>");
$("#cliente").focus();
</script>
<?php
	gest_done($link);
?>