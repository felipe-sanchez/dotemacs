<?php
header("Cache-Control: no-store, no-cache, must-revalidate");
header("Pragma: no-cache");
header("Expires: -1");
$K2 = 0.0002959677292101509;
$MSUN = 2e33;
$MEARTH =  5.97219e27;
try {
  if (file_exists('data/salt.txt'))
    $salt = file_get_contents('data/salt.txt');
  else
    $salt = '';
  if (file_exists('stop'))
    die();

  if (isset($_GET['saveurl']) && isset($_POST["history"])) {
    $dbhandle = new PDO('sqlite:data/hiscores.db');
    if (!$dbhandle)
      die('Could not open database.');
    $his_stm = $dbhandle->prepare("INSERT INTO urls (history) values (:history)");

    if (!$his_stm->execute($_POST)) {
      die();
    }
    print($dbhandle->lastInsertId());
    
  } else if (isset($_GET['debug1']) && $_GET['debug1'] === "copt17.peacefulness") {
        
  } else if (isset($_POST['hiscore-points'])) {
    $dbhandle = new PDO('sqlite:data/hiscores.db');
    if (!$dbhandle)
      die('Could not open database.');

    $points = floatval($_POST['hiscore-points']);
    $years = floatval($_POST['hiscore-years']);
    
    if (!is_finite($points) || !is_finite($years))
      die();
    if ($points/$years > 1e6)
      die();
    $his_stm = $dbhandle->prepare("INSERT INTO hiscores (points, years, url, name, date) values (:points, :years, :url, :name, :date)");
    
    $his_stm->execute(array(points => $_POST['hiscore-points'],
                            years => $_POST['hiscore-years'],
                            url => $_POST['hiscore-url'],
                            name => $_POST['hiscore-name'],
                            date => date(DATE_RFC2822)));
    $id = $dbhandle->lastInsertId();
    $points = $dbhandle->query("SELECT * FROM hiscores ORDER BY points DESC");
    
    foreach ($points as $idx=>$row) {
      if ($row['id'] == $id) {
        print($idx);
        break;
      }
    }
    $points->closeCursor();
  } else if (isset($_GET["hiscores"])) {
   
    $dbhandle = new PDO('sqlite:data/hiscores.db');
    
    $list = $dbhandle->query("SELECT * FROM hiscores ORDER BY points DESC");
    $js = array();
    
    $nRows = $dbhandle->query('select count(*) from urls')->fetchColumn();
    echo '<strong>' . $nRows . "</strong> systems were created so far!<hr>";
    
    echo '<table id="hiscores-table">';
    echo "<tr><th></th><th>Name</th><th>High score</th></tr>\n";
    $idx = 0;
    foreach ($list as $row) {
      /*      echo "<tr><td>" . ($idx+1) . '.</td><td>' .
      substr($row['name'], 0, 12) . '</td><td style="text-align:right">' .
      '<tt><a href="index.php?view=' . $row['url'] . '">' . number_format(round($row['points'])) . '</a></tt></td></tr>';*/

      
      if (!is_finite($row['points']) || !is_numeric($row['points']))
        continue;
      $idx++;
      echo "<tr><td>" . ($idx) . '.</td><td><a href="index.php?view=' . $row['url'] . '">' .
           substr(strip_tags($row['name']), 0, 30) . '</a></td><td style="text-align:right">' .
           '<tt>' . number_format(round($row['points'])) . '</tt></td></tr>';
      
      if (isset($_GET["debug"]) && $_GET["debug"] === "copt17.peacefulness") {
        print("<tr><td><a href='/spc/index.php?view=" . $row['url'] . "'>view</a></td></tr>");
        $st = $dbhandle->prepare("SELECT * FROM urls WHERE ID=?");
        $st->execute(array($row['url']));
        $l = $st->fetchAll();
        print("<pre>");
        print($l[0]['history'] . "</pre><br>");
        $arr = json_decode(stripslashes($l[0]['history']),true);
        
        $max_points = 0;
        $max_mass = 0;
        print("<tr><td>");
        for ($i = 0; $i < count($arr); $i++) {
          $mass = $arr[$i]['mass'] * $MSUN/$MEARTH;
          if ($mass > $max_mass)
            $max_mass = $mass;
          $max_points = $max_points + $mass * (500-$arr[$i]['time']/365.25) * 10 * count($arr);
          print($arr[$i]['time']/365.25 . " " . $mass . "<br>");
        }
        
        print(floatval($row['points']) . " " . $max_points . " " . $row['id']);
        
        if ((floatval($row['points']) > $max_points) || ($max_mass > 31000.)) {
          $st = $dbhandle->prepare("DELETE FROM hiscores WHERE ID=?");
          $st->execute(array($row['id']));
          print_r($dbhandle->errorInfo());
          print("<b>Fake</b>");
          
        }
        
        echo "</td></tr>";
      }
      
      
      if ($idx >= 14)
        break;
    }
    echo '</table>';
    
?>
<?php
} else if (isset($_GET["view"])) {
  $dbhandle = new PDO('sqlite:data/hiscores.db');
  $id = intval($_GET["view"]);
  $list = $dbhandle->query("SELECT * FROM urls WHERE id=" . $id);
  foreach ($list as $row) {
    echo stripslashes($row['history']);
    die();
  }
}
} catch (PDOException $e) {
  die($e->getMessage());
};

$dbhandle = null;

?>
