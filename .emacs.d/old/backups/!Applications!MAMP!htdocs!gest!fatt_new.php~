<?php
	require('lib.php');
	mysql_select_db("mathalic_gest");
	require("top.php");
	
	function save_draft($draft) {
		file_put_contents("draft", 
			serialize($draft));
	}
	
	function restore($arr) {
		echo "function restore() {";
		echo "// Restoring\n";
		foreach (array_keys($arr) as $key) {
			echo "editor." . $key . ".value = " . 
				json_encode(stripslashes($arr[$key])) . ";\n";
		}
		echo "}\n\n";
		
		file_put_contents("draft_cli", 
			serialize($arr));
	}
	
	if (isset($_GET["action"]) && $_GET["action"] == "save") {
		$draft = unserialize(@file_get_contents("draft"));	
		
		$id = $_POST["fatt_id"];
		$fields = mysql_field_names("Fatture");

		foreach ($fields as $field) {
			if (isset($_POST[$field]))
				$parr[$field] = stripslashes($_POST[$field]);
		}
		
		$data = explode("/", $parr['data']);
		$parr['data'] = $data[2]."-".$data[1]."-".$data[0];
		
		mysql_select_db("mathalic_gest");
		if ($id == "") {
			if (mysql_insert("Fatture", $parr) == false) 
				die(mysql_error());
				
			$id = mysql_insert_id();
		} else {
			if (mysql_update("Fatture", $parr, $id) == false)
				die(mysql_error());
				
		}

		mysql_select_db("mathalic_fatture");
		mysql_query("DROP TABLE `" . $id . "`");
		mysql_query("CREATE TABLE `" . $id . "` LIKE Template");
		foreach ($draft as $entry) {
			if (mysql_insert($id, $entry) == false)
				die(mysql_error());
		}

		if (isset($_GET["print"])) {
			echo "<script>\nlocation.href=\"print.php?id=$id\";</script>\n";	
		} else {
			echo "<script>\nlocation.href=\"fatt_new.php?id=$id\";\n</script>\n";	
		}
		return;
	}
	
?>
<style>
#topbar #fatt {
	color:black;
	background-color:white;
	border:2px solid silver;
	border-bottom:none;
}
</style>
<?php if (!isset($_GET["id"])) { ?>
<script>
$("#clienti").attr("href", "#");
$("#clienti").click(function() { 
	editor.action = 'fatt_new.php?action=cliente&url=clienti.php';
	editor.submit();
});
$("#mag").attr("href", "#");
$("#mag").click(function() { 
	editor.action = 'fatt_new.php?action=cliente&url=magazzino.php';
	editor.submit();
});
$("#fatt").attr("href", "#");
$("#fatt").click(function() { 
	editor.action = 'fatt_new.php?action=cliente&url=fatt.php';
	editor.submit();
});
$("#config").attr("href", "#");
$("#config").click(function() { 
	editor.action = 'fatt_new.php?action=cliente&url=config.php';
	editor.submit();
});
</script>
<?php } ?>

<div id="popup" style="display:none">
</div>
<?php
	echo "<table columns=\"2\"><tr><td valign=\"top\" width=\"30%\">";
	
	$hiddenfields = array("oldfat", "datasaldo", "importo", 
		"saldo");

	echo "<input type=\"button\" value=\"<\" onClick=\"location.href='fatt.php';\">&nbsp;";		
	echo "<input type=\"button\" value=\"Salva fattura\" onClick=\"editor.action = 'fatt_new.php?action=save&incrfat=true'; editor.submit()\">&nbsp;";
	echo "<input type=\"button\" value=\"Stampa fattura\" onClick=\"editor.action = 'fatt_new.php?action=save&print=yes'; editor.submit()\">";

	echo "<p>";
	
	mysql_edit_fields("Fatture", "fatt_new.php?action=save", null, $hiddenfields);
	
	if (! isset($_GET["id"])) {
		?>
		
		<script>
		document.getElementById("numfat").value = "<?= gest_get("numfat") + 1; ?>";
		document.getElementById("tipo").value = "FATTURA COMMERCIALE";
		document.getElementById("data").value = "<?= date("d/m/Y"); ?>";
		document.getElementById("ragione").focus();
		</script>
		
		<?php
	}


		echo "<input name=\"fatt_id\" id=\"fatt_id\" value=\"" .
		(isset($_GET["id"]) ? $_GET["id"] : "") . "\"" .
		" type=\"hidden\">";
	echo "<input  name=\"importo\" id=\"importo\" type=\"hidden\">";
	echo "</td><td valign=\"top\" width=\"70%\">";
	
	if (isset($_GET["id"])) {
		$id = $_GET["id"];
		$arr = mysql_array("SELECT * FROM Fatture WHERE ID=" . $id);
		$arr = $arr[0];
		
		$data = explode("-", $arr['data']);
		$arr['data'] = $data[2]."/".$data[1]."/".$data[0];
		
		echo "<script>\n";
		restore($arr);

		echo "restore()\n</script>";
		mysql_select_db("mathalic_fatture");
		$draft = mysql_array("SELECT * FROM `" . $id . "`");
		file_put_contents("draft", serialize($draft));
		
		mysql_select_db("mathalic_gest");
		@unlink("draft_cli");
	}
	
	require 'fatt_do.php';
	echo "</td></tr></table>";

	echo "</form>";
	require 'fatt_clisel.php';
?>
<script>
document.getElementById("importo").value = "<?= sprintf("%.2f", $totimporto + $totimposta); ?>";
document.write("ID: " + document.getElementById("fatt_id").value);
</script>