<?php
	require 'lib.php';
	$id = $_GET["id"];
	mysql_select_db("mathalic_gest");

	$data = mysql_array("SELECT * FROM Fatture WHERE id=" . $id);
	print(mysql_error());
	$data = $data[0];
	
	$date = date_fromsql($data['data']);
	$date_year = substr($date, -2);
	$data = array_map("stripslashes", $data);
	
	mysql_select_db("mathalic_fatture");
	$fattura = mysql_array("SELECT * FROM `" . $id . "`");
	$totimporto = 0.;
	$totimposta = 0.;
	foreach ($fattura as $entry) {
		if ($entry['codice'] < 0)
			continue;
		$importo = (1.-$entry['sconto']/100.) * $entry['num'] * $entry['prezzo'];
		$totimposta += $entry['iva']/100. * $importo;
		$totimporto += $importo;
	}
	$tottotale = $totimporto + $totimposta;
	

	$start = 0;
	$limit = 18;
	for ($i = 0; $i < count($fattura); $i++) {
		// page break
		if (strlen($fattura[$i]['descr']) > 40)
			$limit--;
			
		if (($fattura[$i]['codice'] == -2) || ($i - $start > $limit) || ($i == count($fattura)-1)) {
			$fattura_pieces[] = array_slice($fattura, $start, $i - $start + 1);
			$start = $i + 1;		
			$limit = 18;	
		}
	}
	
?>
<html>
<head>
	<link rel="stylesheet" href="print.css">
	<script type="text/javascript" src="i/js/jquery-1.6.2.min.js"></script>
<link type="text/css" href="i/css/sunny/jquery-ui-1.8.16.custom.css" rel="Stylesheet" />	
<script type="text/javascript" src="i/js/jquery-ui-1.8.16.custom.min.js"></script>
	<title><?= $data['ragione'] ?> - Fattura <?= $data['numfat'] ?> del <?= $date ?></title>
</head>

<body>
<div id="floater">
<input type="button" onClick="location.href='fatt_new.php?id=<?= $_GET["id"] ?>';" value="Torna alle fatture">&nbsp;
<input type="button" onClick="window.print();" value="Stampa">

</div>
<script>
$(function() {
		$( "input:submit, input:button").button();
	});
</script>
<?php
$page = 0;
foreach ($fattura_pieces as $fattura_piece) {
	$page++;
?>
<div class="page" style="<?= ($fattura_piece == end($fattura_pieces) ? "page-break:avoid;" : "") ?>">
<div class="banner">
<img src="i/banner.jpg">
</div>
<div class="tagline">
COSTRUZIONE E RIPARAZIONE FRIGORIFERI INDUSTRIALI
</div>

<table cols="2" class="top_table">
<tr>
<td class="leftbox">
<?= gest_get_html("indirizzo"); ?>
<p>
Modena, li <strong><?= $date ?></strong>
</td>
<td class="rightbox">
<strong><?= $data['ragione'] ?></strong><br>
<?= $data['estragione'] ?><br>
<?= $data['indirizzo'] ?><br>
<?= $data['cap'] ?> <?= $data['citta'] ?> (<?= $data['prov'] ?>)

</td>
</tr>
</table>

<table class="first_row">
<tr>
<th>Tipo</th>
<th>Numero</th>
<th>Codice</th>
<th>Partita Iva</th>
<th>Descrizione pagamento</th>
<th>Banca d'appoggio</th>
</tr>
<tr>
<td><?= $data['tipo'] ?></td>
<td><?= $data['numfat'] ?> / <?= $date_year ?></td>
<td><?= $data['codcli'] ?></td>
<td><?= $data['piva'] ?></td>
<td><?= $data['pag'] ?></td>
<td><?= $data['banca'] ?></td>
</tr>
</table> 

<div class="main">
<table class="main">
<tr>
<th>Codice</th>
<th>Descrizione</th>
<th>UM</th>
<th>Q.ta'</th>
<th>Pr.&nbsp;unitario</th>
<th>Sc.</th>
<th>Importo</th>
<th>IVA</th>
</tr>
<?php
	foreach ($fattura_piece as $entry) { 
		$entry = array_map("stripslashes", $entry);
		if ($entry['codice'] == -2 || trim($entry['descr']) == "")
			continue;
?>
<tr>
<td><?= ($entry['codice'] > 0 ? $entry['codice'] : "") ?>
<?php
	if ($entry['codice'] < 0) {
		echo "<td class=\"annotazione\" colspan=\"7\">";
		echo $entry['descr'];
		echo "</td>";
	} else {
		$importo = (1-$entry['sconto']/100.) * $entry['num'] * $entry['prezzo'];
		$importo = sprintf("%.2f", $importo);
		$prezzo = sprintf("%.2f", $entry['prezzo']);
		
?>	
<td><?= $entry['descr'] ?></td>
<td><?= $entry['um'] ?></td>
<td class="price"><?= $entry['num'] ?></td>
<td class="price"><?= sprintf("%.2f", $entry['prezzo']) ?></td>
<td class="price"><?= ($entry['sconto'] > 0 ? $entry['sconto'] : "") ?></td>
<td class="price"><?= $importo ?></td>
<td class="price"><?= $entry['iva'] ?></td>
<?php		
	}
?>
</tr>
<?php
}
?>
</table>
</div>

<div>
<table class="bottom">
<tr>
<th>Totale importo</th>
<th>Totale imposta</th>
<th>Totale fattura</th>
</tr>
<tr>
<td><?= sprintf("%.2f", $totimporto) ?></td>
<td><?= sprintf("%.2f", $totimposta) ?></td>
<td><?= sprintf("%.2f", $tottotale) ?></td>
</tr>
</table>
</div>
<span class="footer">
Pagina <?= $page ?>/<?= count($fattura_pieces) ?>
</span>
</div>
<?php
}
?>
<script>
$(function () {
	window.print();
});
</script>
</body>
</html>