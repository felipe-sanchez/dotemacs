<?php
	$pwd_md5 = "d73f503563baf474d4c009a81cb6f482";
	
	if (!isset($_SERVER['PHP_AUTH_USER'])) {	
		header('WWW-Authenticate: Basic realm="Gest"');
	    header('HTTP/1.0 401 Unauthorized');
	    exit;
	} else if (md5($_SERVER['PHP_AUTH_PW']) != $pwd_md5) {
		header('WWW-Authenticate: Basic realm="Gest"');	    		header('HTTP/1.0 401 Unauthorized');
		exit;
	}
	
	$link = @mysql_connect('localhost', 'mathalic_gest', 'stout21&adumbration');

		
	if (!file_exists("config.dat")) {
		$config = array(
			"iva" => 20.0,
		);
		file_put_contents("config.dat", serialize($config));
	}
	$config = unserialize(file_get_contents("config.dat"));
	

	
	function gest_get($what) {
		if ($what == "numfat") {
			mysql_select_db("mathalic_gest");
			$year = date("Y");
			$ret = mysql_array("SELECT MAX(numfat) AS num FROM Fatture WHERE YEAR(data)=" . $year);
			if ($ret == false)
				return 0;
			else
				return $ret[0]['num'];
		}
		global $config;
		return $config[$what];
	}
	
	function gest_get_html($what) {
		global $config;
		return str_replace("\n", "<br>", htmlspecialchars($config[$what]));
	}
	
	
	function gest_set($what, $val) {
		global $config;
		$config[$what] = $val;
		file_put_contents("config.dat", serialize($config));
	}
	
	function sanitize_s($what) {
		$what = str_replace("\\", "\\\\", $what);
		$what = str_replace("'", "\\'", $what);
		return $what;
	}

	function sanitize_d($what) {
		$what = str_replace("\"", "\\\"", $what);
		return $what;
	}
	
	function html_escape($what) {
		return htmlentities(stripslashes($what), ENT_COMPAT, "UTF-8");
	}
	
	function js_escape($what) {
		return json_encode(stripslashes($what));
	}
	
	function js_goto($where) {
		echo "<script>\n";
		echo "location.href=" . js_escape($where) . ";";
		echo "</script>";
	}
	
	function mysql_insert($table, $inserts) {
		$cols = mysql_field_names($table);
		
		foreach ($cols as $col) 
			if (isset($inserts[$col])) {
				$vals[$col] = $inserts[$col];
			}

		if (count($vals) == 0)
			return false;
		$vals = array_map('mysql_real_escape_string', $vals);
	    return mysql_query('INSERT INTO `'.$table.'` (`'.implode('`,`', array_keys($vals)).'`) VALUES (\''.implode('\',\'', $vals).'\')');
	}

	function mysql_update($table, $inserts, $id = null) {
		if ($id == null)
			return FALSE;
	    $values = array_map('mysql_real_escape_string', array_values($inserts));
	    $keys = array_keys($inserts);
        
		foreach ($keys as $key) {
			$varr[] = "`" . $key . "`='" . mysql_real_escape_string($inserts[$key]) . "'";
		}
		$query = 'UPDATE `'.$table.'` SET '.implode(", ", $varr) . 
			"WHERE ID=" . $id;
	    return mysql_query($query);
	}

	function show_die($txt) {
		print("<script>\ndocument.clear()\n</script>");
		require("top.php");
		print("<div class=\"alert\">");
		print($txt);
		print("</div>");

		exit();
	}
	
	function show_ok($txt) {
		print("<div class=\"ok\">" . $txt . "</div>");
	}

	function mysql_field_names($table) {
		$cols = mysql_query("SHOW COLUMNS FROM `" . $table . "`");
		while ($row = mysql_fetch_assoc($cols))
			$ret[] = $row["Field"];
		
		return $ret;
	}
	
	function mysql_field_types($table) {
		$result = mysql_query("SHOW COLUMNS FROM " . $table);
		if (mysql_num_rows($result) > 0) {
			while ($row = mysql_fetch_assoc($result))
				$ret[$row["Field"]] = $row["Type"];
		}
		return $ret;
	}
	
	function mysql_edit_fields($table, $actionfile, $id = null, $hide = null) {
		$names = mysql_field_names($table);
		$types = mysql_field_types($table);
		$varr = array();
		
		if ($id != null) {
			$varr = mysql_array("SELECT * FROM " . $table . " WHERE ID=" . $id);
			$varr = $varr[0];
		} else {
			$varr = array_fill_keys($names, "");
		}

		echo "<form name=\"editor\" method=\"post\" action=\"" . $actionfile . "\">";
		echo "<table class=\"editor\">";
		foreach ($names as $name) {
			if ($name == "id")
			 	continue;
			if ($hide != null && array_search($name, $hide) !== FALSE) 
				continue;
			
			echo "<tr><th>" . $name . "</th>";
			echo "<td><input type=\"text\" id=\"" . $name . "\" name=\"" . $name . "\" size=\"40\" value=\"" .
				html_escape($varr[$name]) . "\"></td></tr>\n";
		}
		echo "</table><br>";
		
	}
	
	function mysql_array($query) {
		$result = mysql_query($query);
		if ($result) {
			$varr = array();
			while ($row = mysql_fetch_assoc($result)) {
				$varr[] = $row;
			}
			return $varr;
		}
		return FALSE;
	}
	
	function date_tosql($str) {
		$str = explode("/", $str);
		return $str[2]."-".$str[1]."-".$str[0];
	}
	
	function date_fromsql($str){ 
		$str = explode("-", $str);
		if (count($str) == 1 || $str[0] == "0000")
			return "";
		return $str[2]."/".$str[1]."/".$str[0];
	}
	function mysql_count($table, $header) {
		
	}
	
	function mysql_print($table, $header, $actionfile, $cond = "") {
		$query = "SELECT * FROM " . $table . " " . $cond;
		$types = mysql_field_types($table);
		$result = mysql_query($query);
		if (! $result) {
			die("Query did not work with error " . mysql_error() . " and query " . $query);
		}
		
		echo "<table class=\"print\" cols=" . count($header) . ">\n";
		echo "<tr><th></th>";
		for ($i = 0; $i < count($header); $i++) {
			echo "<th>" . $header[$i] . "</th>";
		}
		echo "</tr>\n";
		
		$k = 0;
		$ret = array();
		while ($row = mysql_fetch_assoc($result)) {
			$ret[] = $row;
			if ($actionfile != null) {
				echo "<tr class=" . ($k % 2 == 0 ? "normal" : "alt") . ">";
				echo "<td><a name=\"" . $k . "\">";
				echo "<a href=\"" . $actionfile . "?action=edit&id=" . $row['id'] . "\"><img src=\"i/edit.png\"></a>";
				echo "<a href=\"" . $actionfile . "?action=delete&id=" . $row['id'] . "\"><img src=\"i/delete.png\"></a>";
				echo "</td>";
			}
			
			foreach ($header as $field)  {
				if (strpos($types[$field], "date") !== FALSE) {
					if ($row[$field][0] == '0')
						$row[$field] = "";
				}
				if (strpos($types[$field], "double") !== FALSE) {
					$row[$field] = sprintf("%.2f", $row[$field]);
					if ($row[$field] == "0.00")
						$row[$field] = "--";
				}
				echo "<td class=\"$field\">" . html_escape($row[$field]) . "</td>";
			}
			$k++;
			echo "</tr>\n";
		}
		echo "</table>";
		mysql_free_result($result);
		return $ret;
	}

	function gest_done($link) {
		mysql_close($link);
		echo "</body></html>";
	}
	
	if (!function_exists('mysql_dump')) {

	   function mysql_dump($database) {
		   $lnbr = "\n";
	      $query = '';

	      $tables = @mysql_list_tables($database);
	      while ($row = @mysql_fetch_row($tables)) { $table_list[] = $row[0]; }

	      for ($i = 0; $i < @count($table_list); $i++) {

	         $results = mysql_query('DESCRIBE ' . $database . '.' . $table_list[$i]);

	         $query .= 'DROP TABLE IF EXISTS `' . $database . '.' . $table_list[$i] . '`;' . $lnbr;
	         $query .= $lnbr . 'CREATE TABLE `' . $database . '.' . $table_list[$i] . '` (' . $lnbr;

	         $tmp = '';

	         while ($row = @mysql_fetch_assoc($results)) {

	            $query .= '`' . $row['Field'] . '` ' . $row['Type'];

	            if ($row['Null'] != 'YES') { $query .= ' NOT NULL'; }
	            if ($row['Default'] != '') { $query .= ' DEFAULT \'' . $row['Default'] . '\''; }
	            if ($row['Extra']) { $query .= ' ' . strtoupper($row['Extra']); }
	            if ($row['Key'] == 'PRI') { $tmp = 'primary key(' . $row['Field'] . ')'; }

	            $query .= ','. $lnbr;

	         }

	         $query .= $tmp . $lnbr . ');' . str_repeat($lnbr, 2);

	         $results = mysql_query('SELECT * FROM ' . $database . '.' . $table_list[$i]);

	         while ($row = @mysql_fetch_assoc($results)) {

	            $query .= 'INSERT INTO `' . $database . '.' . $table_list[$i] .'` (';

	            $data = Array();

	            while (list($key, $value) = @each($row)) { $data['keys'][] = $key; $data['values'][] = addslashes($value); }

	            $query .= join($data['keys'], ', ') . ')' . $lnbr . 'VALUES (\'' . join($data['values'], '\', \'') . '\');' . $lnbr;

	         }

	         $query .= str_repeat($lnbr, 2);

	      }

	      return $query;

	   }

	}
	
	
?>