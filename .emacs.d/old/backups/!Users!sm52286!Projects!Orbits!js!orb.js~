// Physics
var M = 0;
var X = 1;
var Y = 2;
var Z = 3;
var U = 4;
var V = 5;
var W = 6;
var NCOORDS = 7;
var NPHYS = 4;

var AU = 1.4959787e13;
var MSUN = 1.98892e33;
var MJUP = 1.8986e30;
var MEARTH = 5.97219e27;
var RJUP = 7.1e9;
var RSUN = 6.96e10;
var REARTH = 6.3e8;

var GGRAV = 6.67384e-8;
var MIN_DISTANCE = 300 * RJUP/AU;

var DAY = 8.64e4;
var TWOPI = 6.2831853072e+00;
var SQRT_TWOPI = 2.5066282746e+00;
var K2  = ((GGRAV * MSUN * DAY * DAY) / (AU*AU*AU));
var YEAR = 31556926.;

NBODIES = 12;
nbodies = 1;

// Represents the planetary system and evolves the system with time.
var System = (function() {
    
    var xyz = [];
    var f = [];
    var f_1 = [];
    var ui = null;
    var com = new Float64Array(NCOORDS);
    
    var init = function(uiobj) {
        // Initialize arrays
        var i;
        for (i = 0; i < NBODIES; i++) {
            xyz.push(new Float64Array(NCOORDS));
            f.push(new Float64Array(NPHYS));
            f_1.push(new Float64Array(NPHYS));
        };

        // Initialize star
        xyz[0][M] = 1.*K2;
        
        force();
        ui = uiobj;
    };
    

    var addPlanet = function(mass_msun, x, y, vx, vy) {
        if (nbodies >= NBODIES)
            return;
        else {
            xyz[nbodies][X] = x;
            xyz[nbodies][Y] = y;
            x -= xyz[0][X];
            y -= xyz[0][Y];
            
            var r = Math.sqrt(x*x + y*y);
            xyz[nbodies][M] = mass_msun * K2;
            if (vx === undefined) {
                var v = Math.sqrt((xyz[0][M]+xyz[nbodies][M])/r);
                
                xyz[nbodies][U] = v * (-y/r);
                xyz[nbodies][V] = v * (x/r);
            } else {
                xyz[nbodies][U] = vx;
                xyz[nbodies][V] = vy;
            }

            nbodies++;

            
            force();
        }

    };

    
    var center = function() {
        var i, j;
        for (i = 0; i < NCOORDS; i++)
            com[i] = 0.;
        for (i = 0; i < nbodies; i++) {
            com[M] += xyz[i][M];
            for (j = 0; j < NCOORDS; j++) 
                com[j] += xyz[i][j]*xyz[i][M];
        }

        com[X] /= com[M];
        com[Y] /= com[M];
        com[Z] /= com[M];
        com[U] /= com[M];
        com[V] /= com[M];
        com[W] /= com[M];
        
        for (i = 0; i < nbodies; i++)
            for (j = X; j <= W; j++)
                xyz[i][j]-=com[j];
    };

    var force = function() {
        var i, j;

        for (i = 0; i < nbodies; i++) {
            f_1[i].set(f[i]);
            for (j = 0; j < NPHYS; j++)
                f[i][j] = 0.0;
        }
        
        for (i = 0; i < nbodies * NCOORDS; i++) {
            
            for (j = i + 1; j < nbodies; j++) {
                var m1 = xyz[i][M];
                var m2 = xyz[j][M];
                var x = (xyz[i][X] - xyz[j][X]);
                var y = (xyz[i][Y] - xyz[j][Y]);
                var z = (xyz[i][Z] - xyz[j][Z]);
                
                var i_rsq = 1./(x*x+y*y+z*z);
                
                var i_r = Math.sqrt(i_rsq);
                
                if (i_r < MIN_DISTANCE) {
                    UI.crash(i, j);
                    return;
                }
                
                var a1 = -m2 * i_rsq * i_r;
                var a2 = -m1 * i_rsq * i_r;
                
                    
                f[i][X] += x * a1;
                f[j][X] -= x * a2;
                    
                f[i][Y] += y * a1;
                f[j][Y] -= y * a2;
                    
                f[i][Z] += z * a1;
                f[j][Z] -= z * a2;
            }        
        }
    };

    var t = 0.;
    var dt = 1;
    var dt2 = dt*dt;
    
    var evolve = function(n) {
        n = n | 1;
        for (var rep = 0; rep < n; rep++) {
            
            var d;

            // xyz step
            for (i = 0; i < nbodies; i++) 
                for (d = X; d <= Z; d++)
                    xyz[i][d] += xyz[i][d+3] * dt + 0.5 * dt2 * f[i][d];
            
            force();

            // uvw step
            for (i = 0; i < nbodies; i++) {
                for (d = X; d <= Z; d++) {
                    xyz[i][d+3] += 0.5 * dt * (f[i][d] + f_1[i][d]);
                }
            }
            t += dt;
        }
        
        
        return xyz;
    };

    var print = function() {
        for (var i = 0; i < nbodies; i++) {
            console.log(xyz[i][0]-xyz[0][0], xyz[i][1]-xyz[0][1], xyz[i][2]-xyz[0][2], xyz[i][3]-xyz[0][3], xyz[i][4]-xyz[0][4], xyz[i][5]-xyz[0][5], xyz[i][6]-xyz[0][6]);
            console.log(Math.sqrt(sqr(xyz[i][X]-xyz[0][X]) +sqr(xyz[i][Y]-xyz[0][Y]) ));
        }
        console.log(nbodies, t);

        console.log('-----------------');
    };
    
    var benchmark = function() {
        addPlanet(0.001, 1.5, 0);
        addPlanet(0.001, 1.5, 0);
        addPlanet(0.001, 1.5, 0);
        addPlanet(0.001, 1.5, 0);
        addPlanet(0.001, 1.5, 0);
        
        center();
        
        console.time('Start');
        evolve(100000);
        console.timeEnd('Start');
        alert();        
        return;
    };

    var time = function() {
        return t;
    };

    var masses = function() {
        var m = [];
        for (var i = 0; i < nbodies; i++)
            m[i] = xyz[i][M];
        return m;
    };
    
    return {init:init, xyz:xyz, evolve:evolve, addPlanet:addPlanet, benchmark:benchmark, print:print, time:time, center:center, masses:masses};
   
})();

Math.log10 = function(v) {
    return Math.log(v)/Math.LN10;
};

// UI global configuration variables
TAIL_LENGTH = 100;
SPEED = 3;
STOPPED = false;
CRASHED_BARRIER = false;
BASEURL = location.protocol + '//' + location.host + location.pathname;
VIEW_ONLY = (_.parameter("view") != null);

HABITABLE_ZONE_MIN_2 = 0.723*0.723;
HABITABLE_ZONE_MAX_2 = 1.524*1.524;
IN_HABITABLE = 0;

var UI = (function() {
    var curPoints = 0;

    var minMass = MEARTH/MSUN;
    var maxMass = 0.1;
    var minSma = 0.5;
    var minSmaClick = 0.35;
    var maxSma = 2;
    var maxSmaClick = 0.98 * maxSma;
    var maxYears = 500;
    var curMass = MEARTH/MSUN;
    var history = [];
    var viewHistory = null;
    var crowd_multiplier = 1.;
    var hab_multiplier = 1.;
    
    function init() {
        if (! VIEW_ONLY && ! USE_TEMPLATE) {
            var m = Math.pow(10, Math.log10(minMass) + Math.random() * (Math.log10(maxMass) - Math.log10(minMass)));
            var a = minSma + Math.random() * (0.95*maxSma - minSma);
            addPlanetAt(a, 0);
        } else if (VIEW_ONLY) {
            $("#cfg").html("You are watching the pre-recorded evolution of this system. Sit back and relax...<hr>");
            $.get("hiscore.php",
                  {view:_.parameter("view"), token:TOKEN},
                  function(data) {
                      console.log(data);
                      viewHistory = JSON.parse(data);
                      $("#popup").hide();
                      $("#pop-help").hide();
                  });
            
        }
        SCALE = 0.45 * window.innerHeight /maxSma;

        $.get("hiscore.php?hiscores=" + Math.random() + "&token=" + TOKEN,
             null,
             function(data) {
                 $("#highscores-list").append(data);
             });
        
        $(".mass-sel").click(function() {
            curMass = ($(this).data("points"))|0;
            curMass *= MEARTH/MSUN;

            $('#masses li.active').removeClass('active');
            $(this).parent('li').addClass('active');
        });

        $("#pause").click(function() {
            STOPPED = !STOPPED;
            if (STOPPED) {
                $("#pause").html('<span class="glyphicon glyphicon-play"></span>');
            } else {
                $("#pause").html('<span class="glyphicon glyphicon-pause"></span>');
            }
        });
        $("#stop").click(stop);

        $("#help").click(function() {
            $("#popup").show(500);
            $("#pop-help").show();
        });

        $("#pop-highscores").hide();
        $("#pop-points").hide();

        $("#screenshot").click(function() {
            var canvas = document.getElementById("universe");
            var context = canvas.getContext('2d');
            context.fillStyle = 'white';
            context.font = '16px Exo';
            context.fillText('Super Planet Crush - Brought to you by Stefano Meschiari - http://www.stefanom.org/spc', 20, 30);
            var img = canvas.toDataURL("image/png");
            window.open(img, "_blank");
        });

        $("#hiscore-form").submit(function(e) {
            e.preventDefault();
            $("#hiscore-points").val(points());
            $("#hiscore-years").val(years());
            if ($("#hiscore-name").val().trim() == "") {
                alert("Insert a name.");
                return;
            }
                
            $.post('hiscore.php?token=' + TOKEN,
                $(this).serialize(),
                function(data) {
                    alert("High score saved!\nYou are in position #" + ((data|0)+1));
                    location.href = BASEURL;
//                    location.reload();
                }
            );
        });

        $("#hiscore-url-full").click(function() {
            $(this).select();
        });

        $("#faster").click(function() {
            SPEED*=2;
            if (SPEED > 24)
                SPEED = 24;
        });
        $("#slower").click(function() {
            SPEED = Math.round(0.5*SPEED);
            if (SPEED < 1)
                SPEED = 1;
        });

        $("a.spc").attr("href", BASEURL);
    }

    var updateDisplay = _.throttle(function() {
        $("#time").html("Years:<br>" + UI.years() + "/500");
        $("#points").html("Points:<br>" + _.numberWithCommas(UI.points()));
        $("#bonus").html("Crowdedness bonus: " + crowd_multiplier.toFixed(1) + "x<br>" +
                         "Habitability bonus: " + hab_multiplier.toFixed(1) + "x<br>" +
                        "Central star: " + (System.xyz[0][M]/K2).toFixed(1) +"x<br>" +
                        "Speed: " + SPEED + "x");
    }, 500);
    
    function evolve() {
        if (VIEW_ONLY && viewHistory == null)
            return null;
        var ret;
        
        for (var i = 0; i < SPEED; i++) {
            addPoints(1);
            
            if (VIEW_ONLY) {
                var j = viewHistory.length-1;
                while (j >= 0) {
                    if (viewHistory[j].mstar) {
                        System.xyz[0][M] = viewHistory[j].mstar * K2;
//                        System.center();
                    } else if (viewHistory[j].time < System.time()) {
                        curMass = viewHistory[j].mass;
                        addPlanetAt(viewHistory[j].x, viewHistory[j].y, viewHistory.u,
                                   viewHistory[j].v);
                        viewHistory.splice(j, 1);
                    }

                    j--;
                }
            }
           
            ret = System.evolve();
        }

        updateDisplay();

        return ret;
    };

    function addPoints(n) {
        var p = 0;
        var xyz = System.xyz;
        var r = [];
        hab_multiplier = 1.;
        IN_HABITABLE = 0;
        for (i = 1; i < nbodies; i++) {
            p += (xyz[i][M] / K2)*MSUN/MEARTH;
            var rad = (xyz[i][X]*xyz[i][X] + xyz[i][Y]*xyz[i][Y]);
            r[i-1] = rad;
            if (rad > HABITABLE_ZONE_MIN_2 && rad < HABITABLE_ZONE_MAX_2) {
                hab_multiplier ++;
                IN_HABITABLE++;
            }
        }


        if (nbodies > 2) {
            crowd_multiplier = Math.max(Math.min(1/_.sd(r), 10), 1);
        }
        p *= n/(5*365.25) * crowd_multiplier * hab_multiplier;
        curPoints += p;
    }

    var lastSync = -1;
    function sync() {
        if (nbodies != lastSync) {
            $("#nplanets").text(nbodies + " / " + NBODIES + " bodies");
            var xyz = System.xyz;
            $("#planets-list").html('');
            
            for (var i = 1; i < nbodies; i++) {
                var Ma = ' [' + (xyz[i][M] / K2 * MSUN / MEARTH).toFixed(2) + " M<sub>earth</sub>] ";
                var div = $('<div class="planet" id="pla' + (i) + '">' +
                        '<span style="color:' + COLORS[i] + '"> Planet ' +
                            (i) + Ma + "</span>"
                        + '</div><hr>');
                $("#planets-list").append(div);
            }
            lastSync = nbodies;
        }
    }
        
    function addPlanetAt(x, y, vx, vy) {
        if (nbodies == NBODIES)
            return;
        
        var r = Math.sqrt(x*x + y*y);
        if (r < minSmaClick) {
            x *= minSmaClick/r;
            y *= minSmaClick/r;
        } else if (r > maxSmaClick) {
            return;
        }
        
        System.addPlanet(curMass, x, y, vx, vy);
        System.center();
        sync();
        var xyz = System.xyz;
        
        history.push({
            time: System.time(),
            mass: curMass,
            x: xyz[nbodies-1][X],
            y: xyz[nbodies-1][Y],
            z: xyz[nbodies-1][Z],
            u: xyz[nbodies-1][U],
            v: xyz[nbodies-1][V],
            w: xyz[nbodies-1][W]
        });
    }
    
    function points() {
        return Math.round(curPoints);
    }

    var COMBO_ALL_PLANETS = 1e6;
    var COMBO_PLANET_VARIETY = 1e6;
    var COMBO_EARTH_BONANZA = 2.5e6;
    function pointsTally() {
        var p = points();
        var bonus = "Starting points: <b class=pull-right>" + _.numberWithCommas(p) + "</b>";

        // All planets combo
        if (nbodies == 12) {
            bonus += "<br>+ 12 planets combo: <b class=pull-right>" + _.numberWithCommas(COMBO_ALL_PLANETS) + "</b>";
            p += COMBO_ALL_PLANETS;
        }
        if (_.uniq(System.masses()).length >= 6) {
            bonus += "<br>+ Planetary variety combo: <b class=pull-right>" + _.numberWithCommas(COMBO_PLANET_VARIETY) + "</b>";
            p += COMBO_PLANET_VARIETY;
        }
        if (_.uniq(System.masses()).length <= 2) {
            bonus += "<br>+ Boring system combo:  <b class=pull-right>" + _.numberWithCommas(-COMBO_PLANET_VARIETY) + "</b>";
            p -= COMBO_PLANET_VARIETY;
        }
        if (_.filter(System.masses(), function(m) { return m/K2 < 2 * MEARTH/MSUN; }).length >= 3) {
            bonus += "<br>+ Earth bonanza combo: <b class=pull-right>" + _.numberWithCommas(COMBO_EARTH_BONANZA) + "</b>";
            p += COMBO_EARTH_BONANZA;
        }
        $("#pop-points-calc").html(bonus);
        
        return p;
    }

    function mtor(m_int) {
        m_int /= K2;
        var m_j = m_int * MSUN/MJUP;
        var r_j;
        if (m_j > 0.29 && m_j < 13) {
            r_j = 1.;
        } else if (m_j < 0.29) {
            r_j = Math.sqrt(m_j * MJUP/MEARTH) * REARTH/RJUP;
        } else if (m_j > 13) {
            r_j = Math.sqrt(m_int) * RSUN/RJUP;
        }

        r_j = Math.floor(20*Math.pow(r_j, 0.25));

        return r_j;
    }

    function years() {
        return (System.time()/365.25).toFixed(1);
    }

    function stop() {
        STOPPED = true;

        $("#pause").attr("disabled", true);
        $("#stop").text("New game");
        $("#stop").click(function() {
            location.href = BASEURL;
        });

        if (VIEW_ONLY)
            return;

        
        $("#pop-help").hide();
        $("#pop-points").show();
        $("#pop-points-tot").text(_.numberWithCommas(pointsTally()));
        $("#pop-years-tot").text(years());
        $("#popup").show(500);

        $.post(
            'hiscore.php?saveurl=true&token=' + TOKEN,
            {history: JSON.stringify(history)},
            function(ret) {
                $("#hiscore-url-full").val(BASEURL + "?view=" + ret);
                $("#hiscore-url").val(ret);
                $("#hiscore-submit").attr('disabled', false);
            }
            
        );
    }

    function pause() {
        STOPPED = !STOPPED;
    }

    function crash(i, j) {
        $("#pop-why").show();
        $("#pop-why").html("Bodies " + i + " and " + j + " crashed!<hr>");
        stop();
    }
    
    function check() {
        var x = System.xyz;
        for (var i = 0; i < nbodies; i++) {
            if (x[i][X]*x[i][X] + x[i][Y]*x[i][Y] > maxSma*maxSma) {
                STOPPED = true;
                $("#pop-why").show();
                $("#pop-why").html("Body #" + i + " crashed against the barrier at " + maxSma + " AU!<hr>");
            }
        }
        if (STOPPED) {
            CRASHED_BARRIER=true;
            stop();
        }

        if (years() > maxYears) {
            $("#pop-why").show();
            $("#pop-why").html("Congrats! You reached " + maxYears + " years without going unstable!<hr>");
            stop();
        }
        
    }
    
    return {init:init, evolve:evolve, mtor:mtor, years:years,
           points:points, addPlanetAt:addPlanetAt, stop:stop,
           crash:crash, check:check};
})();



$(document).ready(function() {
    System.init(UI);
    UI.init();

    if (_.parameter("benchmark"))
        System.benchmark();
    
});
