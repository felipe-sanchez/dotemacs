library(sqldf)
library(compiler)
library(rjson)
enableJIT(2)

MSUN <- 2e33
MEARTH <- 5.9e27

db <- dbConnect(SQLite(), dbname="hiscores_new2.db")

N <- 8e5
offset <- 1e6
skip <- 50
table <- sqldf("SELECT * from urls limit " %+% N %+% " offset " %+% offset, connection=db)
history <- table$history
x <- c()
y <- c()

for (i in seq(1, N, by=skip)) {
    history.str <- gsub('\\', '', table$history[[i]], fixed=TRUE)
    history <- fromJSON(history.str)

    if (length(history) < 2)
        next
    masses <- sapply(2:length(history), function(j) as.numeric(history[[j]]$mass)) * MSUN/MEARTH
    if (max(masses) > 3e4)
        next
    
    x <- c(x, sapply(2:length(history), function(j) as.numeric(history[[j]]$x)))
    y <- c(y, sapply(2:length(history), function(j) as.numeric(history[[j]]$y)))
}
